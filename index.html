<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Michigan Liquor Price Search with Scanner</title>
  <style>
    /* Your previous styles here, unchanged */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      -webkit-text-size-adjust: 100%;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }
    .search-section {
      margin-bottom: 30px;
      position: relative;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    input:focus {
      border-color: #007bff;
      outline: none;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .help-text {
      background: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      color: #495057;
      margin-top: 10px;
    }
    .results {
      margin-top: 20px;
    }
    .product {
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    .product:hover {
      background: #f0f8ff;
    }
    .product-name {
      font-size: 18px;
      font-weight: bold;
      color: #007bff;
      margin-bottom: 10px;
    }
    .product-details {
      margin-bottom: 15px;
    }
    .detail-row {
      margin-bottom: 5px;
      font-size: 14px;
    }
    .prices {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .price-box {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }
    .price-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .price-value {
      font-size: 16px;
      font-weight: bold;
      color: #007bff;
    }
    .codes {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }
    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    /* Modal styles */
    #modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #modal-content {
      background: white;
      margin: 50px auto;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      box-sizing: border-box;
      position: relative;
    }
    #modal-close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      color: #aaa;
      cursor: pointer;
      border: none;
      background: none;
    }
    #modal-close:hover {
      color: #000;
    }
    #modal-fav-btn {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
      color: #bbb;
      margin-left: 10px;
      vertical-align: middle;
    }
    #modal-fav-btn.favorited {
      color: #e0245e;
    }
    #modal-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 15px;
      display: inline-block;
      vertical-align: middle;
    }
    /* Responsive */
    @media (max-width: 480px) {
      .prices {
        flex-direction: column;
      }
      .price-box {
        min-width: auto;
      }
    }

    /* Scanner UI */
    #scanner-container {
      display: none;
      position: fixed;
      z-index: 1500;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.75);
      justify-content: center;
      align-items: center;
      padding: 10px;
    }
    #scanner {
      width: 100%;
      max-width: 600px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px #000;
      background: #000;
    }
    #close-scanner-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #fff;
      border: none;
      font-size: 20px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1600;
    }
    #scan-result {
      color: #fff;
      margin-top: 10px;
      font-size: 18px;
      text-align: center;
    }

    /* Scan button */
    #scan-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      width: 100%;
    }
    #scan-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>üç∑ Michigan Liquor Price Search</h1>
    <p class="subtitle">Search the Michigan Liquor Control Commission price database</p>

    <div class="search-section">
      <input
        type="text"
        id="searchBox"
        placeholder="Search by item code, name, or type..."
        aria-label="Search liquor products"
        autocomplete="off"
      />
      <button id="scan-btn" aria-label="Scan barcode to search">üì∑ Scan Barcode</button>
      <div id="status" class="status" role="alert" aria-live="polite"></div>
      <div class="help-text">
        <strong>Search Tips:</strong> Try "Grey Goose", "Bourbon", "Vodka", or codes like "121"
      </div>
    </div>

    <div id="results" class="results" aria-live="polite" aria-atomic="true"></div>
  </div>

  <!-- Modal -->
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true">
    <div id="modal-content">
      <button id="modal-close" aria-label="Close details">&times;</button>
      <h2 id="modal-title"></h2>
      <button id="modal-fav-btn" aria-label="Add to favorites">&#9825;</button>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Scanner container -->
  <div id="scanner-container" role="dialog" aria-modal="true" aria-label="Barcode scanner" aria-hidden="true">
    <button id="close-scanner-btn" aria-label="Close scanner">&times;</button>
    <div id="scanner"></div>
    <div id="scan-result"></div>
  </div>

  <!-- html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script>
    // Variables
    let liquorData = [];
    let isLoaded = false;

    const searchBox = document.getElementById('searchBox');
    const status = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalCloseBtn = document.getElementById('modal-close');
    const modalFavBtn = document.getElementById('modal-fav-btn');

    const scannerContainer = document.getElementById('scanner-container');
    const scannerDiv = document.getElementById('scanner');
    const closeScannerBtn = document.getElementById('close-scanner-btn');
    const scanResult = document.getElementById('scan-result');
    const scanBtn = document.getElementById('scan-btn');

    // Barcode scanner instance
    let html5QrcodeScanner;

    // Helpers
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
    }

    function normalizeCode(code) {
      if (!code) return '';
      return code.replace(/^0+/, '') || '0';
    }

    function normalizeUPC(upc) {
      if (!upc) return '';
      let trimmed = upc.replace(/^0{2}/, '');
      if (trimmed.length < 12) {
        trimmed = trimmed.padStart(12, '0');
      } else if (trimmed.length > 12) {
        trimmed = trimmed.slice(0,12);
      }
      return trimmed;
    }

    function fixPrice(rawPrice) {
      if (!rawPrice) return 0;
      const cleaned = rawPrice.replace(/\.{2,}/g, '.');
      const num = parseFloat(cleaned);
      return isNaN(num) ? 0 : num;
    }

    function formatPrice(num) {
      return '$' + num.toFixed(2);
    }

    function formatProof(proof) {
      if (!proof) return '';
      let p = proof.trim();
      p = p.replace(/^0+/, '');
      return p || '0.0';
    }

    function parseLine(line) {
      return {
        liquorCode: normalizeCode(line.slice(0,5).trim()),
        brandName: line.slice(5,37).trim(),
        adaNumber: line.slice(37,40).trim(),
        adaName: line.slice(40,65).trim(),
        vendorName: line.slice(65,90).trim(),
        liquorType: line.slice(90,110).trim(),
        proof: line.slice(110,115).trim(),
        bottleSize: line.slice(115,122).trim(),
        packSize: line.slice(122,125).trim(),
        onPremPrice: fixPrice(line.slice(125,136).trim()),
        offPremPrice: fixPrice(line.slice(136,147).trim()),
        shelfPrice: fixPrice(line.slice(147,158).trim()),
        upc1: normalizeUPC(line.slice(158,172).trim()),
        upc2: normalizeUPC(line.slice(172,186).trim()),
        effectiveDate: line.slice(186,194).trim(),
      };
    }

    async function loadData() {
      status.style.display = 'block';
      status.className = 'status';
      status.textContent = 'Loading data...';

      try {
        const response = await fetch('./webprbk.txt');
        if (!response.ok) throw new Error('Network response was not ok');
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim().length >= 194);
        liquorData = lines.map(parseLine);
        isLoaded = true;
        status.className = 'status success';
        status.textContent = `‚úÖ Loaded ${liquorData.length} products. Start searching!`;
        searchBox.disabled = false;
      } catch (err) {
        status.className = 'status error';
        status.textContent = '‚ùå Failed to load data. Please make sure the file "webprbk.txt" is in the same folder.';
        searchBox.disabled = true;
      }
    }

    function searchProducts(query) {
      if (!query || query.length < 2) return [];
      const q = query.toLowerCase();

      const results = liquorData.filter(p =>
        p.liquorCode.toLowerCase().includes(q) ||
        p.brandName.toLowerCase().includes(q) ||
        p.liquorType.toLowerCase().includes(q) ||
        p.vendorName.toLowerCase().includes(q) ||
        p.upc1.toLowerCase().includes(q) ||
        p.upc2.toLowerCase().includes(q)
      );

      return results.slice(0, 30);
    }

    function displayResults(products) {
      if (!products.length) {
        resultsDiv.innerHTML = `<div class="no-results"><h3>No results found</h3><p>Try a different search term</p></div>`;
        return;
      }

      let html = '';
      for (const p of products) {
        html += `
          <div class="product" tabindex="0" role="button" aria-pressed="false" data-code="${escapeHtml(p.liquorCode)}">
            <div class="product-name">${escapeHtml(p.brandName)}</div>
            <div class="product-details">
              <div class="detail-row"><strong>Type:</strong> ${escapeHtml(p.liquorType)}</div>
              <div class="detail-row"><strong>Size:</strong> ${escapeHtml(p.bottleSize)} | <strong>Proof:</strong> ${formatProof(p.proof)}</div>
              <div class="detail-row"><strong>Vendor:</strong> ${escapeHtml(p.vendorName)}</div>
            </div>
            <div class="prices">
              <div class="price-box">
                <div class="price-label">On-Premise</div>
                <div class="price-value">${formatPrice(p.onPremPrice)}</div>
              </div>
              <div class="price-box">
                <div class="price-label">Off-Premise</div>
                <div class="price-value">${formatPrice(p.offPremPrice)}</div>
              </div>
              <div class="price-box">
                <div class="price-label">Shelf Price</div>
                <div class="price-value">${formatPrice(p.shelfPrice)}</div>
              </div>
            </div>
            <div class="codes">Code: ${escapeHtml(p.liquorCode)} | UPC1: ${escapeHtml(p.upc1)}${p.upc2 ? ` | UPC2: ${escapeHtml(p.upc2)}` : ''}</div>
          </div>
        `;
      }
      resultsDiv.innerHTML = html;

      document.querySelectorAll('.product').forEach(el => {
        el.addEventListener('click', () => openModal(el.getAttribute('data-code')));
        el.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openModal(el.getAttribute('data-code'));
          }
        });
      });
    }

    function openModal(code) {
      const p = liquorData.find(item => item.liquorCode === code);
      if (!p) return;

      modalTitle.textContent = p.brandName;
      modalTitle.setAttribute('data-code', p.liquorCode);
      modalBody.innerHTML = `
        <p><strong>Item Code:</strong> ${escapeHtml(p.liquorCode)}</p>
        <p><strong>ADA Number:</strong> ${escapeHtml(p.adaNumber)} ‚Äî ${escapeHtml(p.adaName)}</p>
        <p><strong>Vendor:</strong> ${escapeHtml(p.vendorName)}</p>
        <p><strong>Type:</strong> ${escapeHtml(p.liquorType)}</p>
        <p><strong>Proof:</strong> ${formatProof(p.proof)}</p>
        <p><strong>Bottle Size:</strong> ${escapeHtml(p.bottleSize)}</p>
        <p><strong>Pack Size:</strong> ${escapeHtml(p.packSize)}</p>
        <p><strong>On-Premise Price:</strong> ${formatPrice(p.onPremPrice)}</p>
        <p><strong>Off-Premise Price:</strong> ${formatPrice(p.offPremPrice)}</p>
        <p><strong>Shelf Price:</strong> ${formatPrice(p.shelfPrice)}</p>
        <p><strong>UPC #1:</strong> ${escapeHtml(p.upc1)}</p>
        <p><strong>UPC #2:</strong> ${escapeHtml(p.upc2)}</p>
        <p><strong>Effective Date:</strong> ${escapeHtml(p.effectiveDate)}</p>
      `;

      updateFavoriteButton(code);

      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');
      modalCloseBtn.focus();
    }

    function closeModal() {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    modalCloseBtn.addEventListener('click', closeModal);

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && modal.style.display === 'block') {
        closeModal();
      }
    });

    // Favorites management in localStorage
    function getFavorites() {
      const fav = localStorage.getItem('favorites') || '[]';
      try {
        return JSON.parse(fav);
      } catch {
        return [];
      }
    }

    function saveFavorites(favs) {
      localStorage.setItem('favorites', JSON.stringify(favs));
    }

    function updateFavoriteButton(code) {
      const favs = getFavorites();
      if (favs.includes(code)) {
        modalFavBtn.classList.add('favorited');
        modalFavBtn.innerHTML = '&#10084;'; // solid heart
        modalFavBtn.setAttribute('aria-label', 'Remove from favorites');
      } else {
        modalFavBtn.classList.remove('favorited');
        modalFavBtn.innerHTML = '&#9825;'; // empty heart
        modalFavBtn.setAttribute('aria-label', 'Add to favorites');
      }
    }

    modalFavBtn.addEventListener('click', () => {
      const code = modalTitle.getAttribute('data-code');
      if (!code) return;

      const favs = getFavorites();
      if (favs.includes(code)) {
        const idx = favs.indexOf(code);
        favs.splice(idx, 1);
      } else {
        favs.push(code);
      }
      saveFavorites(favs);
      updateFavoriteButton(code);
    });

    // Search handling
    searchBox.addEventListener('input', e => {
      if (!isLoaded) return;

      const query = e.target.value.trim();
      if (query.length >= 2) {
        const results = searchProducts(query);
        displayResults(results);
      } else {
        resultsDiv.innerHTML = '';
      }
    });

    // --- SCANNER Integration ---

    function openScanner() {
      scanResult.textContent = '';
      scannerContainer.style.display = 'flex';
      scannerContainer.setAttribute('aria-hidden', 'false');

      html5QrcodeScanner = new Html5Qrcode("scanner");

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 100 },
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
        formatsToSupport: [
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.ITF,
          Html5QrcodeSupportedFormats.QR_CODE // just in case item codes as QR
        ],
      };

      html5QrcodeScanner.start(
        { facingMode: "environment" },
        config,
        qrCodeMessage => {
          scanResult.textContent = `Scanned: ${qrCodeMessage}`;
          stopScanner();
          // Insert scanned code into search box and trigger search
          searchBox.value = qrCodeMessage;
          searchBox.dispatchEvent(new Event('input'));
          closeScanner();
        },
        errorMessage => {
          // no need to do anything on scan failure for now
        }
      ).catch(err => {
        scanResult.textContent = 'Error starting camera: ' + err;
      });
    }

    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
          html5QrcodeScanner.clear();
          html5QrcodeScanner = null;
        }).catch(err => {
          console.warn('Failed to stop scanner:', err);
        });
      }
    }

    function closeScanner() {
      stopScanner();
      scannerContainer.style.display = 'none';
      scannerContainer.setAttribute('aria-hidden', 'true');
    }

    scanBtn.addEventListener('click', () => {
      openScanner();
    });
    closeScannerBtn.addEventListener('click', () => {
      closeScanner();
    });

    // Load data on start
    window.addEventListener('load', () => {
      searchBox.disabled = true;
      loadData();
    });

  </script>
</body>
</html>
