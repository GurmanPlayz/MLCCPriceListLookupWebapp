<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Michigan Liquor Price Search with QuaggaJS Scanner</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f5f5f5;
  }

  .container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  h1 {
    color: #333;
    text-align: center;
    margin-bottom: 10px;
  }

  .subtitle {
    text-align: center;
    color: #666;
    margin-bottom: 30px;
  }

  .search-section {
    margin-bottom: 30px;
  }

  button {
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    width: 100%;
    margin-bottom: 15px;
  }

  button:hover {
    background: #0056b3;
  }

  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
    box-sizing: border-box;
  }

  input:focus {
    border-color: #007bff;
    outline: none;
  }

  .status {
    padding: 10px;
    margin: 10px 0;
    border-radius: 5px;
    display: none;
  }

  .status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .help-text {
    background: #e9ecef;
    padding: 10px;
    border-radius: 5px;
    font-size: 14px;
    color: #495057;
    margin-top: 10px;
  }

  .results {
    margin-top: 20px;
  }

  .product {
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 15px;
    padding: 15px;
    background: white;
  }

  .product-name {
    font-size: 18px;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 10px;
  }

  .product-details {
    margin-bottom: 15px;
  }

  .detail-row {
    margin-bottom: 5px;
    font-size: 14px;
  }

  .prices {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }

  .price-box {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
    flex: 1;
    min-width: 120px;
  }

  .price-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
  }

  .price-value {
    font-size: 16px;
    font-weight: bold;
    color: #007bff;
  }

  .codes {
    font-size: 12px;
    color: #666;
    margin-top: 10px;
  }

  .no-results {
    text-align: center;
    padding: 40px;
    color: #666;
  }

  /* Scanner modal */
  #scannerContainer {
    display: none;
    position: fixed;
    z-index: 1000;
    top:0; left:0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.75);
    justify-content: center;
    align-items: center;
  }

  #scanner {
    width: 90vw;
    max-width: 500px;
    height: 300px;
    border: 5px solid white;
    border-radius: 10px;
    background: black;
  }

  #closeScannerBtn {
    margin-top: 10px;
    padding: 10px 20px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
</style>

</head>
<body>
  <div class="container">
    <h1>üç∑ Michigan Liquor Price Search</h1>
    <p class="subtitle">Search the Michigan Liquor Control Commission price database</p>

    <div class="search-section">
      <button id="scanBtn">Scan Barcode</button>
      <input type="text" id="searchBox" placeholder="Search by code, name, or type..." disabled />
      <div id="status" class="status"></div>
      <div class="help-text">
        <strong>Search Tips:</strong> Try "Grey Goose", "Bourbon", "Vodka", or product codes like "121" or UPC codes.
      </div>
    </div>

    <div id="results" class="results"></div>
  </div>

  <!-- Scanner modal -->
  <div id="scannerContainer" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Barcode Scanner">
    <div>
      <div id="scanner"></div>
      <button id="closeScannerBtn" aria-label="Close Scanner">Close Scanner</button>
    </div>
  </div>

  <!-- QuaggaJS -->
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<script>
  let liquorData = [];
  let isLoaded = false;

  const statusEl = document.getElementById('status');
  const resultsDiv = document.getElementById('results');
  const searchBox = document.getElementById('searchBox');
  const scanBtn = document.getElementById('scanBtn');
  const scannerContainer = document.getElementById('scannerContainer');
  const closeScannerBtn = document.getElementById('closeScannerBtn');

  // Load data from local text file in repo
  async function loadData() {
    try {
      const response = await fetch('webprbk.txt');
      if (!response.ok) throw new Error('Failed to fetch data');
      const rawText = await response.text();
      liquorData = parseData(rawText);
      isLoaded = true;
      searchBox.disabled = false;
      showStatus('‚úÖ Data loaded successfully', 'success');
    } catch(e) {
      showStatus('‚ùå Error loading data: ' + e.message, 'error');
    }
  }

  // Parse fixed-width file data into objects
  function parseData(text) {
    const lines = text.split('\n');
    const products = [];
    for(let line of lines){
      if(line.length < 194) continue; // skip invalid lines

      const codeRaw = line.slice(0, 5).trim();
      const code = codeRaw.replace(/^0+/, ''); // remove leading zeros

      const brandName = line.slice(5, 37).trim();
      const adaNumber = line.slice(37, 40).trim();
      const adaName = line.slice(40, 65).trim();
      const vendorName = line.slice(65, 90).trim();
      const liquorType = line.slice(90, 110).trim();
      const proof = line.slice(110, 115).trim();
      const bottleSize = line.slice(115, 122).trim();
      const packSize = line.slice(122, 125).trim();

      // Prices: remove multiple dots, parse float, fallback to 0
      function parsePrice(raw) {
        let cleaned = raw.replace(/\.+/g, '.'); // replace multiple dots with single dot
        let val = parseFloat(cleaned);
        return isNaN(val) ? 0 : val;
      }

      const onPremisePrice = parsePrice(line.slice(125, 136).trim());
      const offPremisePrice = parsePrice(line.slice(136, 147).trim());
      const shelfPrice = parsePrice(line.slice(147, 158).trim());

      // UPC: remove first two leading zeros if any, then ensure 12 digits (pad end if needed)
      function cleanUPC(raw) {
        let s = raw.trim();
        if (s.length === 14 && s.startsWith('00')) {
          s = s.slice(2);
        }
        if(s.length === 8) {
          // Convert UPC-E to UPC-A (will handle later)
          return s;
        }
        // pad or trim to 12
        if (s.length < 12) s = s.padEnd(12, '0');
        if (s.length > 12) s = s.slice(0,12);
        return s;
      }
      const upc1 = cleanUPC(line.slice(158, 172));
      const upc2 = cleanUPC(line.slice(172, 186));
      const effectiveDate = line.slice(186, 194).trim();

      products.push({
        code,
        name: brandName,
        adaNumber,
        adaName,
        vendor: vendorName,
        type: liquorType,
        proof,
        size: bottleSize,
        packSize,
        onPrice: onPremisePrice,
        offPrice: offPremisePrice,
        shelfPrice,
        upc1,
        upc2,
        effectiveDate,
      });
    }
    return products;
  }

  function formatPrice(price) {
    return price === 0 ? 'N/A' : '$' + price.toFixed(2);
  }

  function searchProducts(query) {
    if (!query || query.length < 2) return [];
    const searchTerm = query.toLowerCase();

    return liquorData.filter(p => {
      return (
        p.code.toLowerCase().includes(searchTerm) ||
        p.name.toLowerCase().includes(searchTerm) ||
        p.type.toLowerCase().includes(searchTerm) ||
        p.vendor.toLowerCase().includes(searchTerm) ||
        (p.upc1 && p.upc1.includes(searchTerm)) ||
        (p.upc2 && p.upc2.includes(searchTerm))
      );
    }).slice(0, 20);
  }

  function displayResults(products) {
    if (products.length === 0) {
      resultsDiv.innerHTML = '<div class="no-results"><h3>No results found</h3><p>Try a different search term</p></div>';
      return;
    }
    let html = '';
    for (let p of products) {
      html += `<div class="product">
        <div class="product-name">${p.name}</div>
        <div class="product-details">
          <div class="detail-row"><strong>Type:</strong> ${p.type}</div>
          <div class="detail-row"><strong>Size:</strong> ${p.size} | <strong>Proof:</strong> ${p.proof}</div>
          <div class="detail-row"><strong>Vendor:</strong> ${p.vendor}</div>
        </div>
        <div class="prices">
          <div class="price-box"><div class="price-label">On-Premise</div><div class="price-value">${formatPrice(p.onPrice)}</div></div>
          <div class="price-box"><div class="price-label">Off-Premise</div><div class="price-value">${formatPrice(p.offPrice)}</div></div>
          <div class="price-box"><div class="price-label">Shelf Price</div><div class="price-value">${formatPrice(p.shelfPrice)}</div></div>
        </div>
        <div class="codes">Code: ${p.code} | UPC1: ${p.upc1} | UPC2: ${p.upc2}</div>
      </div>`;
    }
    resultsDiv.innerHTML = html;
  }

  function showStatus(msg, type) {
    statusEl.textContent = msg;
    statusEl.className = 'status ' + type;
    statusEl.style.display = 'block';
  }

  // Convert UPC-E (8 digits) to UPC-A (12 digits)
  // Algorithm based on https://en.wikipedia.org/wiki/Universal_Product_Code#UPC-E
  function upcEtoUPC_A(upce) {
    if (!/^\d{8}$/.test(upce)) return upce;
    const lastDigit = upce[7];
    const manufacturer = upce.slice(1, 6);
    let upca = '';
    switch(lastDigit) {
      case '0':
      case '1':
      case '2':
        upca = upce[0] + manufacturer.slice(0, 2) + lastDigit + '0000' + manufacturer.slice(2, 5);
        break;
      case '3':
        upca = upce[0] + manufacturer.slice(0, 3) + '00000' + manufacturer.slice(3, 5);
        break;
      case '4':
        upca = upce[0] + manufacturer.slice(0, 4) + '00000' + manufacturer[4];
        break;
      default:
        upca = upce[0] + manufacturer + '0000' + lastDigit;
    }
    return upca + upce[6];
  }

  // Start QuaggaJS scanner
  function startScanner() {
    scanResult.textContent = '';
    scannerContainer.style.display = 'flex';
    scannerContainer.setAttribute('aria-hidden', 'false');

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        constraints: {
          facingMode: "environment"
        },
        target: document.querySelector('#scanner'),
        area: { // scanning area
          top: "25%",    // top offset
          right: "10%",  // right offset
          left: "10%",   // left offset
          bottom: "25%"  // bottom offset
        },
      },
      decoder: {
        readers: [
          "upc_reader",
          "upc_e_reader",
          "ean_reader",
          "ean_8_reader",
          "code_128_reader",
          "code_39_reader",
          "code_93_reader",
          "codabar_reader",
          "i2of5_reader",
          "2of5_reader"
        ],
        multiple: false
      },
      locate: true,
      numOfWorkers: navigator.hardwareConcurrency || 4,
    }, function(err) {
      if (err) {
        showStatus('‚ùå Error initializing scanner: ' + err, 'error');
        return;
      }
      Quagga.start();
      showStatus('Scanner started. Point your camera at a barcode.', 'success');
    });

    Quagga.onDetected(onDetected);
  }

  function stopScanner() {
    Quagga.stop();
    scannerContainer.style.display = 'none';
    scannerContainer.setAttribute('aria-hidden', 'true');
    Quagga.offDetected(onDetected);
  }

  // On barcode detected:
  function onDetected(result) {
    if (!result || !result.codeResult || !result.codeResult.code) return;

    let code = result.codeResult.code;

    // If UPC-E 8 digit code, convert to UPC-A 12 digit
    if (result.codeResult.format === 'upc_e' && code.length === 8) {
      code = upcEtoUPC_A(code);
    }

    showStatus(`Scanned: ${code}`, 'success');

    stopScanner();

    // Set code to search box and trigger search
    searchBox.value = code;
    searchBox.dispatchEvent(new Event('input'));
  }

  // Event listeners
  scanBtn.addEventListener('click', () => {
    if (!isLoaded) {
      showStatus('Data not loaded yet. Please wait.', 'error');
      return;
    }
    startScanner();
  });

  closeScannerBtn.addEventListener('click', () => {
    stopScanner();
  });

  searchBox.addEventListener('input', e => {
    if (!isLoaded) return;
    const query = e.target.value.trim();
    if (query.length >= 2) {
      const results = searchProducts(query);
      displayResults(results);
    } else {
      resultsDiv.innerHTML = '';
    }
  });

  // Load data on page load
  window.addEventListener('load', loadData);
</script>

</body>
</html>
