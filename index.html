<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üç∑ Michigan Liquor Price Search</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
    }
    
    .search-section {
      margin-bottom: 25px;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    select, input[type="text"] {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 2px solid #ddd;
      flex-grow: 1;
      min-width: 150px;
      box-sizing: border-box;
    }
    
    select:focus, input[type="text"]:focus {
      border-color: #007bff;
      outline: none;
    }
    
    button.clear-btn {
      position: absolute;
      right: 30px;
      top: 132px;
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      user-select: none;
    }
    
    button.clear-btn:hover {
      color: #007bff;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .help-text {
      background: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      color: #495057;
      margin-top: 10px;
    }
    
    .results {
      margin-top: 20px;
    }
    
    .product {
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      transition: box-shadow 0.2s ease;
      cursor: pointer;
      position: relative;
    }
    
    .product:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    
    .product-name {
      font-size: 18px;
      font-weight: bold;
      color: #007bff;
      margin-bottom: 10px;
    }
    
    .product-details {
      margin-bottom: 15px;
      font-size: 14px;
      color: #444;
    }
    
    .detail-row {
      margin-bottom: 5px;
    }
    
    .prices {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .price-box {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }
    
    .price-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .price-value {
      font-size: 16px;
      font-weight: bold;
      color: #007bff;
    }
    
    .codes {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      word-break: break-word;
    }
    
    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* Modal styles */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; top: 0; width: 100%; height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,.3);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(-20px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 15px;
    }

    .close-btn:hover {
      color: #000;
    }

    .favorite-btn {
      position: absolute;
      top: 10px;
      left: 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: #ccc;
      user-select: none;
      transition: color 0.3s;
    }
    .favorite-btn.favorited {
      color: #e74c3c;
    }

    /* Loading spinner */
    .spinner {
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #007bff; 
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Mobile friendly tweaks */
    @media (max-width: 480px) {
      .filters {
        flex-direction: column;
      }
      select, input[type="text"] {
        min-width: 100%;
      }
      button.clear-btn {
        top: 110px;
        right: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üç∑ Michigan Liquor Price Search</h1>
    <p class="subtitle">Search the Michigan Liquor Control Commission price database</p>
    
    <div class="search-section">
      <div class="filters">
        <input
          type="text"
          id="searchBox"
          placeholder="Search by item code, UPC #1, UPC #2, or item name..."
          autocomplete="off"
          spellcheck="false"
        />
        <select id="filterType" title="Filter by Liquor Type">
          <option value="">All Types</option>
        </select>
        <select id="filterProof" title="Filter by Proof Range">
          <option value="">All Proofs</option>
          <option value="low">&lt; 80</option>
          <option value="medium">80 - 100</option>
          <option value="high">&gt; 100</option>
        </select>
        <select id="filterPrice" title="Filter by On-Prem Price">
          <option value="">All Prices</option>
          <option value="low">&lt; $10</option>
          <option value="medium">$10 - $25</option>
          <option value="high">&gt; $25</option>
        </select>
      </div>
      <button class="clear-btn" title="Clear Search & Filters" aria-label="Clear Search & Filters" style="display:none;">‚úï</button>
      <div id="status" class="status"></div>
    </div>
    
    <div id="results" class="results"></div>
  </div>

  <!-- Modal -->
  <div id="productModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <button class="favorite-btn" id="modalFavBtn" title="Toggle Favorite" aria-label="Toggle Favorite">&#9825;</button>
      <span class="close-btn" id="modalCloseBtn" title="Close">&times;</span>
      <h2 id="modalTitle"></h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const DATA_FILE = 'webprbk.txt'; // Your data file location
    let liquorData = [];
    let filteredData = [];
    let favorites = new Set();
    let isLoaded = false;
    let debounceTimer;

    // Modal elements
    const modal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalFavBtn = document.getElementById('modalFavBtn');

    // Elements
    const searchBox = document.getElementById('searchBox');
    const filterType = document.getElementById('filterType');
    const filterProof = document.getElementById('filterProof');
    const filterPrice = document.getElementById('filterPrice');
    const clearBtn = document.querySelector('.clear-btn');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');

    // Parse fixed width line into object
    function parseLine(line) {
      return {
        liquorCode: line.substring(0, 5).trim(),
        brandName: line.substring(5, 37).trim(),
        adaNumber: line.substring(37, 40).trim(),
        adaName: line.substring(40, 65).trim(),
        vendorName: line.substring(65, 90).trim(),
        liquorType: line.substring(90, 110).trim(),
        proof: line.substring(110, 115).trim(),
        bottleSize: line.substring(115, 122).trim(),
        packSize: line.substring(122, 125).trim(),
        onPremPrice: line.substring(125, 136).trim(),
        offPremPrice: line.substring(136, 147).trim(),
        shelfPrice: line.substring(147, 158).trim(),
        upc1: line.substring(158, 172).trim(),
        upc2: line.substring(172, 186).trim(),
        effectiveDate: line.substring(186, 194).trim(),
      };
    }

    function formatPrice(str) {
      if (!str || str.length < 3) return '';
      let dollars = str.slice(0, -2).replace(/^0+/, '') || '0';
      let cents = str.slice(-2);
      return `$${dollars}.${cents}`;
    }

    function formatProof(str) {
      if (!str) return '';
      if (str.includes('.')) return str;
      let num = parseInt(str, 10);
      if (isNaN(num)) return str;
      return (num / 10).toFixed(1);
    }

    function formatDate(str) {
      if (!str || str.length !== 8) return str;
      let mm = str.slice(0, 2);
      let dd = str.slice(2, 4);
      let yy = str.slice(4, 6);
      let yyyy = '20' + yy;
      return `${mm}/${dd}/${yyyy}`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m]);
    }

    // Load favorites from localStorage
    function loadFavorites() {
      const favs = localStorage.getItem('miLiquorFavorites');
      if (favs) {
        favorites = new Set(JSON.parse(favs));
      }
    }

    // Save favorites to localStorage
    function saveFavorites() {
      localStorage.setItem('miLiquorFavorites', JSON.stringify(Array.from(favorites)));
    }

    // Toggle favorite for liquorCode
    function toggleFavorite(code) {
      if (favorites.has(code)) favorites.delete(code);
      else favorites.add(code);
      saveFavorites();
    }

    // Check if liquorCode is favorite
    function isFavorite(code) {
      return favorites.has(code);
    }

    // Load data on page load
    async function loadData() {
      setStatus('Loading data, please wait...', '');
      disableInputs(true);

      try {
        const res = await fetch(DATA_FILE);
        if (!res.ok) throw new Error('Failed to load data file.');

        const text = await res.text();
        const lines = text.split('\n').filter(line => line.length >= 194);
        liquorData = lines.map(parseLine);
        isLoaded = true;
        loadFavorites();

        populateTypeFilter();
        setStatus(`‚úÖ Loaded ${liquorData.length} products. You can now search!`, 'success');
        disableInputs(false);
        searchBox.focus();
        filterAndDisplay();
      } catch (e) {
        setStatus('‚ùå Error loading data: ' + e.message, 'error');
        disableInputs(false);
      }
    }

    // Disable or enable inputs during loading
    function disableInputs(disable) {
      searchBox.disabled = disable;
      filterType.disabled = disable;
      filterProof.disabled = disable;
      filterPrice.disabled = disable;
      clearBtn.style.display = disable ? 'none' : clearBtn.style.display;
    }

    // Set status message
    function setStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.style.display = msg ? 'block' : 'none';
      statusEl.className = 'status ' + (type || '');
    }

    // Populate Liquor Type filter options dynamically from data
    function populateTypeFilter() {
      const types = new Set(liquorData.map(p => p.liquorType).filter(t => t));
      const sorted = Array.from(types).sort((a,b) => a.localeCompare(b));
      filterType.innerHTML = '<option value="">All Types</option>' + 
        sorted.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    }

    // Filter and display products according to inputs
    function filterAndDisplay() {
      if (!isLoaded) return;

      let q = searchBox.value.trim().toLowerCase();
      const typeFilter = filterType.value;
      const proofFilter = filterProof.value;
      const priceFilter = filterPrice.value;

      // Filter
      filteredData = liquorData.filter(p => {
        // Search term match
        let searchMatch = (
          p.liquorCode.toLowerCase().includes(q) ||
          p.upc1.toLowerCase().includes(q) ||
          p.upc2.toLowerCase().includes(q) ||
          p.brandName.toLowerCase().includes(q) ||
          p.adaName.toLowerCase().includes(q)
        );

        if (q.length > 0 && !searchMatch) return false;

        // Type filter
        if (typeFilter && p.liquorType !== typeFilter) return false;

        // Proof filter
        const proofNum = parseFloat(formatProof(p.proof));
        if (proofFilter === 'low' && proofNum >= 80) return false;
        if (proofFilter === 'medium' && (proofNum < 80 || proofNum > 100)) return false;
        if (proofFilter === 'high' && proofNum <= 100) return false;

        // Price filter (On-prem price)
        const priceNum = parseFloat(formatPrice(p.onPremPrice).replace('$', '')) || 0;
        if (priceFilter === 'low' && priceNum >= 10) return false;
        if (priceFilter === 'medium' && (priceNum < 10 || priceNum > 25)) return false;
        if (priceFilter === 'high' && priceNum <= 25) return false;

        return true;
      });

      // Sort alphabetically by brandName
      filteredData.sort((a, b) => a.brandName.localeCompare(b.brandName));

      displayResults(filteredData);
      toggleClearButton();
    }

    // Display clear button if search/filter active
    function toggleClearButton() {
      if (
        searchBox.value.trim() !== '' ||
        filterType.value !== '' ||
        filterProof.value !== '' ||
        filterPrice.value !== ''
      ) {
        clearBtn.style.display = 'block';
      } else {
        clearBtn.style.display = 'none';
      }
    }

    // Display search results
    function displayResults(products) {
      if (products.length === 0) {
        resultsEl.innerHTML = `<div class="no-results">
          <h3>No results found</h3>
          <p>Try changing your search or filters.</p>
        </div>`;
        return;
      }

      // Show total count
      let html = `<p><strong>${products.length} result${products.length !== 1 ? 's' : ''} found.</strong></p>`;

      for (const p of products) {
        html += `
          <div class="product" tabindex="0" data-code="${p.liquorCode}">
            <div class="product-name">${escapeHtml(p.brandName)}</div>
            <div class="product-details">
              <div class="detail-row"><strong>Type:</strong> ${escapeHtml(p.liquorType)}</div>
              <div class="detail-row"><strong>Size:</strong> ${escapeHtml(p.bottleSize)} | <strong>Proof:</strong> ${formatProof(p.proof)}</div>
              <div class="detail-row"><strong>Vendor:</strong> ${escapeHtml(p.vendorName)}</div>
            </div>
            <div class="prices">
              <div class="price-box">
                <div class="price-label">On-Premise</div>
                <div class="price-value">${formatPrice(p.onPremPrice)}</div>
              </div>
              <div class="price-box">
                <div class="price-label">Off-Premise</div>
                <div class="price-value">${formatPrice(p.offPremPrice)}</div>
              </div>
              <div class="price-box">
                <div class="price-label">Shelf Price</div>
                <div class="price-value">${formatPrice(p.shelfPrice)}</div>
              </div>
            </div>
            <div class="codes">Code: ${escapeHtml(p.liquorCode)}${p.upc1 ? ' | UPC1: ' + escapeHtml(p.upc1) : ''}${p.upc2 ? ' | UPC2: ' + escapeHtml(p.upc2) : ''}</div>
          </div>
        `;
      }

      resultsEl.innerHTML = html;

      // Attach click + keyboard handler for modal
      document.querySelectorAll('.product').forEach(elem => {
        elem.onclick = () => openModal(elem.getAttribute('data-code'));
        elem.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openModal(elem.getAttribute('data-code'));
          }
        };
      });
    }

    // Open modal with product details
    function openModal(code) {
      const p = liquorData.find(item => item.liquorCode === code);
      if (!p) return;

      modalTitle.textContent = p.brandName;
      modalBody.innerHTML = `
        <p><strong>Liquor Code:</strong> ${escapeHtml(p.liquorCode)}</p>
        <p><strong>ADA Number:</strong> ${escapeHtml(p.adaNumber)}</p>
        <p><strong>ADA Name:</strong> ${escapeHtml(p.adaName)}</p>
        <p><strong>Vendor:</strong> ${escapeHtml(p.vendorName)}</p>
        <p><strong>Liquor Type:</strong> ${escapeHtml(p.liquorType)}</p>
        <p><strong>Proof:</strong> ${formatProof(p.proof)}</p>
        <p><strong>Bottle Size:</strong> ${escapeHtml(p.bottleSize)}</p>
        <p><strong>Pack Size:</strong> ${escapeHtml(p.packSize)}</p>
        <p><strong>On-Premise Price:</strong> ${formatPrice(p.onPremPrice)}</p>
        <p><strong>Off-Premise Price:</strong> ${formatPrice(p.offPremPrice)}</p>
        <p><strong>Shelf Price:</strong> ${formatPrice(p.shelfPrice)}</p>
        <p><strong>UPC Code 1:</strong> ${escapeHtml(p.upc1)}</p>
        <p><strong>UPC Code 2:</strong> ${escapeHtml(p.upc2)}</p>
        <p><strong>Effective Date:</strong> ${formatDate(p.effectiveDate)}</p>
      `;

      // Update favorite button state
      updateFavButton(code);

      // Show modal
      modal.style.display = 'block';

      // Trap focus inside modal (basic)
      modalCloseBtn.focus();
    }

    // Close modal
    function closeModal() {
      modal.style.display = 'none';
    }

    // Update favorite button style
    function updateFavButton(code) {
      if (isFavorite(code)) {
        modalFavBtn.classList.add('favorited');
        modalFavBtn.innerHTML = '&#9829;'; // filled heart
      } else {
        modalFavBtn.classList.remove('favorited');
        modalFavBtn.innerHTML = '&#9825;'; // empty heart
      }
      modalFavBtn.dataset.code = code;
    }

    // Handle favorite toggle click
    modalFavBtn.onclick = () => {
      const code = modalFavBtn.dataset.code;
      if (!code) return;
      toggleFavorite(code);
      updateFavButton(code);
      filterAndDisplay(); // Refresh results to reflect favorite state if you want
    };

    // Close modal handlers
    modalCloseBtn.onclick = closeModal;
    window.onclick = e => {
      if (e.target === modal) closeModal();
    };
    window.onkeydown = e => {
      if (e.key === 'Escape' && modal.style.display === 'block') {
        closeModal();
      }
    };

    // Debounce function
    function debounce(func, wait = 300) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Search and filter handler (debounced)
    const onSearchChange = debounce(() => {
      filterAndDisplay();
    }, 350);

    searchBox.addEventListener('input', () => {
      onSearchChange();
      toggleClearButton();
    });
    filterType.addEventListener('change', () => {
      filterAndDisplay();
      toggleClearButton();
    });
    filterProof.addEventListener('change', () => {
      filterAndDisplay();
      toggleClearButton();
    });
    filterPrice.addEventListener('change', () => {
      filterAndDisplay();
      toggleClearButton();
    });

    clearBtn.addEventListener('click', () => {
      searchBox.value = '';
      filterType.value = '';
      filterProof.value = '';
      filterPrice.value = '';
      toggleClearButton();
      filterAndDisplay();
      searchBox.focus();
    });

    // Initialize app
    loadData();
  </script>
</body>
</html>
