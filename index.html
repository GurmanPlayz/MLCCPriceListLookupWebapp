<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üç∑ Michigan Liquor Price Search</title>
  <style>
    /* (Styles unchanged, omitted for brevity; same as before) */
  </style>
</head>
<body>
  <div class="container">
    <h1>üç∑ Michigan Liquor Price Search</h1>
    <p class="subtitle">Search the Michigan Liquor Control Commission price database</p>
    
    <div class="search-section">
      <div class="filters">
        <input
          type="text"
          id="searchBox"
          placeholder="Search by item code, UPC #1, UPC #2, or item name..."
          autocomplete="off"
          spellcheck="false"
        />
        <select id="filterType" title="Filter by Liquor Type">
          <option value="">All Types</option>
        </select>
        <select id="filterProof" title="Filter by Proof Range">
          <option value="">All Proofs</option>
          <option value="low">&lt; 80</option>
          <option value="medium">80 - 100</option>
          <option value="high">&gt; 100</option>
        </select>
        <select id="filterPrice" title="Filter by On-Premise Price">
          <option value="">All Prices</option>
          <option value="low">&lt; $10</option>
          <option value="medium">$10 - $25</option>
          <option value="high">&gt; $25</option>
        </select>
      </div>
      <button class="clear-btn" title="Clear Search & Filters" aria-label="Clear Search & Filters" style="display:none;">‚úï</button>
      <div id="status" class="status"></div>
    </div>
    
    <div id="results" class="results"></div>
  </div>

  <!-- Modal -->
  <div id="productModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <button class="favorite-btn" id="modalFavBtn" title="Toggle Favorite" aria-label="Toggle Favorite">&#9825;</button>
      <span class="close-btn" id="modalCloseBtn" title="Close">&times;</span>
      <h2 id="modalTitle"></h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const DATA_FILE = 'webprbk.txt';
    let liquorData = [];
    let filteredData = [];
    let favorites = new Set();
    let isLoaded = false;

    const modal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalFavBtn = document.getElementById('modalFavBtn');

    const searchBox = document.getElementById('searchBox');
    const filterType = document.getElementById('filterType');
    const filterProof = document.getElementById('filterProof');
    const filterPrice = document.getElementById('filterPrice');
    const clearBtn = document.querySelector('.clear-btn');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');

    // Helper: remove leading zeros from item codes
    function trimLeadingZeros(str) {
      return str.replace(/^0+/, '') || '0';
    }

    // Helper: format UPC to 12 digits by removing first two zeros if present
    function formatUPC(upc) {
      if (!upc) return '';
      // Remove all non-digits first to be safe
      let digits = upc.replace(/\D/g, '');
      if (digits.length === 14 && digits.startsWith('00')) {
        digits = digits.slice(2);
      }
      // If longer than 12, truncate left, if shorter, pad left zeros
      if (digits.length > 12) digits = digits.slice(-12);
      if (digits.length < 12) digits = digits.padStart(12, '0');
      return digits;
    }

    // Format price string from raw data: fix double dots and leading zeros
    function formatPrice(str) {
      if (!str || str.length < 3) return '';
      // Remove any unexpected extra dots
      let clean = str.replace(/\.{2,}/g, '.').replace(/^0+/, '');
      // Add decimal point two digits from right
      let dollars = clean.slice(0, -2) || '0';
      let cents = clean.slice(-2);
      // Remove leading zeros in dollars but keep at least '0'
      dollars = dollars.replace(/^0+/, '') || '0';
      return `$${dollars}.${cents}`;
    }

    function formatProof(str) {
      if (!str) return '';
      if (str.includes('.')) return str;
      let num = parseInt(str, 10);
      if (isNaN(num)) return str;
      return (num / 10).toFixed(1);
    }

    function formatDate(str) {
      if (!str || str.length !== 8) return str;
      let mm = str.slice(0, 2);
      let dd = str.slice(2, 4);
      let yy = str.slice(4, 6);
      let yyyy = '20' + yy;
      return `${mm}/${dd}/${yyyy}`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m]);
    }

    function loadFavorites() {
      const favs = localStorage.getItem('miLiquorFavorites');
      if (favs) {
        favorites = new Set(JSON.parse(favs));
      }
    }

    function saveFavorites() {
      localStorage.setItem('miLiquorFavorites', JSON.stringify(Array.from(favorites)));
    }

    function toggleFavorite(code) {
      if (favorites.has(code)) favorites.delete(code);
      else favorites.add(code);
      saveFavorites();
    }

    function isFavorite(code) {
      return favorites.has(code);
    }

    async function loadData() {
      setStatus('Loading data, please wait...', '');
      disableInputs(true);

      try {
        const res = await fetch(DATA_FILE);
        if (!res.ok) throw new Error('Failed to load data file.');

        const text = await res.text();
        const lines = text.split('\n').filter(line => line.length >= 194);
        liquorData = lines.map(line => {
          let p = parseLine(line);
          // Remove leading zeros in liquorCode:
          p.liquorCode = trimLeadingZeros(p.liquorCode);
          // Format UPCs to 12-digit without first two zeros
          p.upc1 = formatUPC(p.upc1);
          p.upc2 = formatUPC(p.upc2);
          return p;
        });
        isLoaded = true;
        loadFavorites();

        populateTypeFilter();
        setStatus(`‚úÖ Loaded ${liquorData.length} products. You can now search!`, 'success');
        disableInputs(false);
        searchBox.focus();
        filterAndDisplay();
      } catch (e) {
        setStatus('‚ùå Error loading data: ' + e.message, 'error');
        disableInputs(false);
      }
    }

    function disableInputs(disable) {
      searchBox.disabled = disable;
      filterType.disabled = disable;
      filterProof.disabled = disable;
      filterPrice.disabled = disable;
      clearBtn.style.display = disable ? 'none' : clearBtn.style.display;
    }

    function setStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.style.display = msg ? 'block' : 'none';
      statusEl.className = 'status ' + (type || '');
    }

    function populateTypeFilter() {
      const types = new Set(liquorData.map(p => p.liquorType).filter(t => t));
      const sorted = Array.from(types).sort((a,b) => a.localeCompare(b));
      filterType.innerHTML = '<option value="">All Types</option>' + 
        sorted.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    }

    function filterAndDisplay() {
      if (!isLoaded) return;

      let q = searchBox.value.trim().toLowerCase();
      const typeFilter = filterType.value;
      const proofFilter = filterProof.value;
      const priceFilter = filterPrice.value;

      filteredData = liquorData.filter(p => {
        let searchMatch = (
          p.liquorCode.toLowerCase().includes(q) ||
          p.upc1.toLowerCase().includes(q) ||
          p.upc2.toLowerCase().includes(q) ||
          p.brandName.toLowerCase().includes(q) ||
          p.adaName.toLowerCase().includes(q)
        );

        if (q.length > 0 && !searchMatch) return false;
        if (typeFilter && p.liquorType !== typeFilter) return false;

        const proofNum = parseFloat(formatProof(p.proof));
        if (proofFilter === 'low' && proofNum >= 80) return false;
        if (proofFilter === 'medium' && (proofNum < 80 || proofNum > 100)) return false;
        if (proofFilter === 'high' && proofNum <= 100) return false;

        const priceNum = parseFloat(formatPrice(p.onPremPrice).replace('$', '')) || 0;
        if (priceFilter === 'low' && priceNum >= 10) return false;
        if (priceFilter === 'medium' && (priceNum < 10 || priceNum > 25)) return false;
        if (priceFilter === 'high' && priceNum <= 25) return false;

        return true;
      });

      filteredData.sort((a, b) => a.brandName.localeCompare(b.brandName));
      displayResults(filteredData);
      toggleClearButton();
    }

    function toggleClearButton() {
      if (
        searchBox.value.trim() !== '' ||
        filterType.value !== '' ||
        filterProof.value !== '' ||
        filterPrice.value !== ''
      ) {
        clearBtn.style.display = 'block';
      } else {
        clearBtn.style.display = 'none';
      }
    }

    function displayResults(products) {
      if (products.length === 0) {
        resultsEl.innerHTML = `<div class="no-results">
          <h3>No results found</h3>
          <p>Please try different search terms or filters.</p>
        </div>`;
        return;
      }

      let html = `<p><strong>${products.length} result${products.length !== 1 ? 's' : ''} found.</strong></p>`;

      for (const p of products) {
        html += `
          <div class="product" tabindex="0" data-code="${p.liquorCode}">
            <div class="product-name">${escapeHtml(p.brandName)}</div>
            <div class="product-details">
              <div class="detail-row"><strong>Type:</strong> ${escapeHtml(p.liquorType)}</div>
              <div class="detail-row"><strong>Size:</strong> ${escapeHtml(p.bottleSize)} | <strong>Proof:</strong> ${formatProof(p.proof)}</div>
              <div class="detail-row"><strong>Vendor:</strong> ${escapeHtml(p.vendorName)}</div>
            </div>
            <div class="prices">
              <div class="price-box">
                <div class="price-label">On-Premise</div>
                <div class="price-value">${formatPrice(p.onPremPrice)}</div>
              </div>
              <div class="price-box">
                <div class="price-label">Off-Premise</div>
                <div class="price-value">${formatPrice(p.offPremPrice)}</div>
              </div>
              <div class="price-box">
                <div class="price-label">Shelf Price</div>
                <div class="price-value">${formatPrice(p.shelfPrice)}</div>
              </div>
            </div>
            <div class="codes">Code: ${escapeHtml(p.liquorCode)}${p.upc1 ? ' | UPC1: ' + escapeHtml(p.upc1) : ''}${p.upc2 ? ' | UPC2: ' + escapeHtml(p.upc2) : ''}</div>
          </div>
        `;
      }

      resultsEl.innerHTML = html;

      document.querySelectorAll('.product').forEach(elem => {
        elem.onclick = () => openModal(elem.getAttribute('data-code'));
        elem.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openModal(elem.getAttribute('data-code'));
          }
        };
      });
    }

    function openModal(code) {
      const p = liquorData.find(item => item.liquorCode === code);
      if (!p) return;

      modalTitle.textContent = p.brandName;
      modalBody.innerHTML = `
        <p><strong>Liquor Code:</strong> ${escapeHtml(p.liquorCode)}</p>
        <p><strong>ADA Number:</strong> ${escapeHtml(p.adaNumber)}</p>
        <p><strong>ADA Name:</strong> ${escapeHtml(p.adaName)}</p>
        <p><strong>Vendor:</strong> ${escapeHtml(p.vendorName)}</p>
        <p><strong>Liquor Type:</strong> ${escapeHtml(p.liquorType)}</p>
        <p><strong>Proof:</strong> ${formatProof(p.proof)}</p>
        <p><strong>Bottle Size:</strong> ${escapeHtml(p.bottleSize)}</p>
        <p><strong>Pack Size:</strong> ${escapeHtml(p.packSize)}</p>
        <p><strong>On-Premise Price:</strong> ${formatPrice(p.onPremPrice)}</p>
        <p><strong>Off-Premise Price:</strong> ${formatPrice(p.offPremPrice)}</p>
        <p><strong>Shelf Price:</strong> ${formatPrice(p.shelfPrice)}</p>
        <p><strong>UPC Code 1:</strong> ${escapeHtml(p.upc1)}</p>
        <p><strong>UPC Code 2:</strong> ${escapeHtml(p.upc2)}</p>
        <p><strong>Effective Date:</strong> ${formatDate(p.effectiveDate)}</p>
      `;

      updateFavButton(code);
      modal.style.display = 'block';
      modalCloseBtn.focus();
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    function updateFavButton(code) {
      if (isFavorite(code)) {
        modalFavBtn.classList.add('favorited');
        modalFavBtn.innerHTML = '&#9829;'; // filled heart
      } else {
        modalFavBtn.classList.remove('favorited');
        modalFavBtn.innerHTML = '&#9825;'; // empty heart
      }
      modalFavBtn.dataset.code = code;
    }

    modalFavBtn.onclick = () => {
      const code = modalFavBtn.dataset.code;
      if (!code) return;
      toggleFavorite(code);
      updateFavButton(code);
      filterAndDisplay();
    };

    modalCloseBtn.onclick = closeModal;
    window.onclick = e => {
      if (e.target === modal) closeModal();
    };
    window.onkeydown = e => {
      if (e.key === 'Escape' && modal.style.display === 'block') {
        closeModal();
      }
    };

    function debounce(func, wait = 300) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    const onSearchChange = debounce(() => {
      filterAndDisplay();
    }, 350);

    searchBox.addEventListener('input', () => {
      onSearchChange();
      toggleClearButton();
    });
    filterType.addEventListener('change', () => {
      filterAndDisplay();
      toggleClearButton();
    });
    filterProof.addEventListener('change', () => {
      filterAndDisplay();
      toggleClearButton();
    });
    filterPrice.addEventListener('change', () => {
      filterAndDisplay();
      toggleClearButton();
    });

    clearBtn.addEventListener('click', () => {
      searchBox.value = '';
      filterType.value = '';
      filterProof.value = '';
      filterPrice.value = '';
      toggleClearButton();
      filterAndDisplay();
      searchBox.focus();
    });

    // Parses fixed width line from data file
    function parseLine(line) {
      return {
        liquorCode: line.substring(0, 5).trim(),
        brandName: line.substring(5, 37).trim(),
        adaNumber: line.substring(37, 40).trim(),
        adaName: line.substring(40, 65).trim(),
        vendorName: line.substring(65, 90).trim(),
        liquorType: line.substring(90, 110).trim(),
        proof: line.substring(110, 115).trim(),
        bottleSize: line.substring(115, 122).trim(),
        packSize: line.substring(122, 125).trim(),
        onPremPrice: line.substring(125, 136).trim(),
        offPremPrice: line.substring(136, 147).trim(),
        shelfPrice: line.substring(147, 158).trim(),
        upc1: line.substring(158, 172).trim(),
        upc2: line.substring(172, 186).trim(),
        effectiveDate: line.substring(186, 194).trim(),
      };
    }

    loadData();
  </script>
</body>
</html>
